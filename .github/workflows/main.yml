name: Build and Publish to Itch

on:
  push:
    tags:
      - 'v*' # Triggers when you push a tag like v0.1, v0.2, etc.

env:
  UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
  ITCH_GAME: when-we-found-us
  ITCH_USER: ddanakim0304

jobs:
  buildAndDeploy:
    name: Build for ${{ matrix.targetPlatform }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - targetPlatform: WebGL
            os: ubuntu-latest

          - targetPlatform: StandaloneWindows64
            os: ubuntu-latest

          - targetPlatform: StandaloneOSX
            os: macos-latest

    steps:
      # 1. Checkout Code
      - uses: actions/checkout@v4
        with:
          lfs: true

      # 2. Cache Library (Speeds up builds)
      - uses: actions/cache@v3
        with:
          path: game-prototype/Library
          key: Library-${{ matrix.targetPlatform }}
          restore-keys: |
            Library-

      # 3. Build Unity Project
      - uses: game-ci/unity-builder@v4
        with:
          targetPlatform: ${{ matrix.targetPlatform }}
          projectPath: game-prototype
          buildName: ${{ env.ITCH_GAME }}

      # 4. Set the Itch.io Channel Name (The Magic Step)
      # This checks if we are building WebGL or Windows and names the channel accordingly
      - name: Set Itch Channel
        run: |
          if [ "${{ matrix.targetPlatform }}" == "WebGL" ]; then
            echo "ITCH_CHANNEL=web" >> $GITHUB_ENV
          elif [ "${{ matrix.targetPlatform }}" == "StandaloneWindows64" ]; then
            echo "ITCH_CHANNEL=windows" >> $GITHUB_ENV
          elif [ "${{ matrix.targetPlatform }}" == "StandaloneOSX" ]; then
            echo "ITCH_CHANNEL=mac" >> $GITHUB_ENV
          fi

      # 5. Upload to Itch.io
      - uses: manolevesque/itchio-butler-action@v1
        with:
          butlerApiKey: ${{ secrets.BUTLER_API_KEY }}
          itchUser: ${{ env.ITCH_USER }}
          itchGame: ${{ env.ITCH_GAME }}
          version: ${{ github.ref_name }}
          buildData: build/${{ matrix.targetPlatform }}
          channel: ${{ env.ITCH_CHANNEL }} # Uses the variable we set in Step 4